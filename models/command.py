import subprocess
import shlex


class video():
    def __init__(
            self,
            requested,
            command,
            process
        ):
        self.id = 0
        self.status = False
        self.requested = requested
        self.last = ""
        self.lasts = []
        self.command = command
        self.process = process

        self.getId()

    def active(self):
        self.status = True

    def deactive(self):
        self.staus = False

    def addLine(self):
        self.last = self.process.stdout.readline()


        if len(self.lasts) > 50:
            self.lasts.pop(0)
            
        self.lasts.append(self.process.stdout.readline())

    def getId(self):
        # ps aux | grep gst
        try:
            self.id = self.process.pid
            return True
        except:
            return False


# test = video("yo", "gst-launch-1.0 -e rtmpsrc location=rtmp://192.168.88.253:1950/live/origin8 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin7 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin6 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin5 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin4 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin3 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin2 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin1 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix.  gldmdstitcher name=mix client=vrinsitu template=stitch-templates/template.pts ! video/x-raw\(memory:GLMemory\),format=RGBA,width=7680,height=4320 ! tee name=t t. ! queue ! nvh265enc preset=1 ! h265parse ! hlssink2 target-duration=2 location=videos/high/8kplaylist%05d.ts playlist-location=videos/high/8kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=3840,height=2160 ! nvh265enc preset=1 ! h265parse ! hlssink2 target-duration=2 location=videos/high/4kplaylist%05d.ts playlist-location=videos/high/4kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=2560,height=1440 ! nvh264enc preset=1 ! h264parse ! hlssink2 target-duration=2 location=videos/low/2kplaylist%05d.ts playlist-location=videos/low/2kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=1920,height=1080 ! nvh264enc preset=1 ! h264parse ! hlssink2 target-duration=2 location=videos/low/1kplaylist%05d.ts playlist-location=videos/low/1kplaylist.m3u8",subprocess.Popen(shlex.split("gst-launch-1.0 -e rtmpsrc location=rtmp://192.168.88.253:1950/live/origin8 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin7 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin6 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin5 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin4 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin3 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin2 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin1 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix.  gldmdstitcher name=mix client=vrinsitu template=stitch-templates/template.pts ! video/x-raw\(memory:GLMemory\),format=RGBA,width=7680,height=4320 ! tee name=t t. ! queue ! nvh265enc preset=1 ! h265parse ! hlssink2 target-duration=2 location=videos/high/8kplaylist%05d.ts playlist-location=videos/high/8kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=3840,height=2160 ! nvh265enc preset=1 ! h265parse ! hlssink2 target-duration=2 location=videos/high/4kplaylist%05d.ts playlist-location=videos/high/4kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=2560,height=1440 ! nvh264enc preset=1 ! h264parse ! hlssink2 target-duration=2 location=videos/low/2kplaylist%05d.ts playlist-location=videos/low/2kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=1920,height=1080 ! nvh264enc preset=1 ! h264parse ! hlssink2 target-duration=2 location=videos/low/1kplaylist%05d.ts playlist-location=videos/low/1kplaylist.m3u8"), stdout=subprocess.PIPE, stderr=subprocess.STDOUT, universal_newlines=True))

# test.addLine()

# test = video("yo", "gst-launch-1.0 -e rtmpsrc location=rtmp://192.168.88.253:1950/live/origin8 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin7 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin6 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin5 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin4 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin3 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin2 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix. rtmpsrc location=rtmp://192.168.88.253:1950/live/origin1 ! flvdemux ! h264parse ! nvh264dec ! video/x-raw\(memory:GLMemory\),format=NV12,width=3840,height=2160 ! glcolorconvert ! video/x-raw\(memory:GLMemory\),format=RGBA,width=3840,height=2160 ! mix.  gldmdstitcher name=mix client=vrinsitu template=stitch-templates/template.pts ! video/x-raw\(memory:GLMemory\),format=RGBA,width=7680,height=4320 ! tee name=t t. ! queue ! nvh265enc preset=1 ! h265parse ! hlssink2 target-duration=2 location=videos/high/8kplaylist%05d.ts playlist-location=videos/high/8kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=3840,height=2160 ! nvh265enc preset=1 ! h265parse ! hlssink2 target-duration=2 location=videos/high/4kplaylist%05d.ts playlist-location=videos/high/4kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=2560,height=1440 ! nvh264enc preset=1 ! h264parse ! hlssink2 target-duration=2 location=videos/low/2kplaylist%05d.ts playlist-location=videos/low/2kplaylist.m3u8 t. ! queue ! glcolorscale ! video/x-raw\(memory:GLMemory\),width=1920,height=1080 ! nvh264enc preset=1 ! h264parse ! hlssink2 target-duration=2 location=videos/low/1kplaylist%05d.ts playlist-location=videos/low/1kplaylist.m3u8"